#!INCLUDE_ONLY
#//////////////////////////////////////////////////
#//DESLinux Builder
#//	(C)2014-2022 Dark Embedded Systems.
#//	http://xprj.net/
#//////////////////////////////////////////////////

# Check run conrition
[ "${DESL_BUILDER_X:-0}" = '0' ] && {
	error "This script must run from DESLBuilder."
	return 1;
}

# Includes
. "${SCRIPTS_DIR}/ArgsParser.sh"
. "${SCRIPTS_DIR}/ConfigManager.sh"
. "${SCRIPTS_DIR}/RunScripts.sh"
. "${INCLUDES_DIR}/DependencyResolver.sh"
. "${INCLUDES_DIR}/DESLBPackageReader.sh"

EBSRunDESLBScript(){ # mode
	local BUILD_MODE="${1}";
	# Enable verbose output (To reduce 'if')
	[ ! "${DESL_OUTPUT_VERBOSE:-0}" = '0' ] && . "${INCLUDES_DIR}/VerboseOutput_Build.sh"

	# Mount tmp, toolchain usr / tools directory
	mount -t tmpfs tmp://DESLBuilder/ExecBuildScript/session /tmp
	mount -o bind "${CURRENT_TOOLCHAIN_USR_DIR}" "${TOOLCHAIN_USR_DIR}" || return ${?};
	mount -o bind "${CURRENT_TOOLCHAIN_TOOLS_DIR}" "${TOOLCHAIN_TOOLS_DIR}" || return ${?};


	PKG_FILE="${PACKAGES_DIR}/${DESL_BUILD_PACKAGE}/DESLPackage.def";
	PackageLoad "${DESL_BUILD_PACKAGE}" "${PKG_FILE}" || return ${?};

	# Redirect package
	[ ! "${Package_Redirect}" = '-' ] && {
		DESL_BUILD_PACKAGE="${Package_Redirect}";
		PKG_FILE="${PACKAGES_DIR}/${DESL_BUILD_PACKAGE}/DESLPackage.def";
		PackageLoad "${DESL_BUILD_PACKAGE}" "${PKG_FILE}" || return ${?};
	}

	# Load default script
	. "${DEFAULTS_DIR}/DESLBScript.sh"
	. "${INCLUDES_DIR}/DESLBScript_Helper.sh"

	# Make writable build directory
	vinfo "Preparing build directory"
	export CURRENT_BUILD_DIR="${BUILD_DIR}/${Package_Source_RootDir}";
	export SHARED_BUILD_DIR="${SHARED_SOURCE_ROOT_DIR}/${Package_Source_RootDir}";
	export CURRENT_PACKAGE_DIR="${PACKAGES_DIR}/${DESL_BUILD_PACKAGE}";

	vinfo "Loading DESLBScript.sh"
	[ -e "${PACKAGES_DIR}/${DESL_BUILD_PACKAGE}/DESLBScript.sh" ] && {
		vinfo "No DESLBScript.sh found. Using default DESLBScript.sh"
		. "${PACKAGES_DIR}/${DESL_BUILD_PACKAGE}/DESLBScript.sh"
	}

	vinfo "Open build / package directory"
	EBSPrepareBuildDirectory "${CURRENT_BUILD_DIR}" "${SHARED_BUILD_DIR}" || return ${?};

	cd "${CURRENT_BUILD_DIR}"
	vinfo "Starting build process: ${BUILD_MODE}"
	case "${BUILD_MODE}" in
		Config )
			case "${2}" in
				'' )
					case "${DESLB_SKIP_CONFIG_IF_EXISTS}" in
						'' | '-' )
							EBSStartMessage 'Config'
							DESLBInitialize || return ${?};
							DESLBConfig || return ${?};
						;;
						* )
							[ -e "${DESLB_SKIP_CONFIG_IF_EXISTS}" ] && {
								info "Already configured. Use '/Reconfig' to reconfigure."
								return 0;
							}
							EBSStartMessage 'Config'
							DESLBInitialize || return ${?};
							DESLBConfig || return ${?};
						;;
					esac
				;;
				'force' )
					EBSStartMessage 'Config'
					DESLBInitialize || return ${?};
					DESLBConfig || return ${?};
				;;
				'defconfig' ) error "NOT IMPLEMENTED"; return 1;;
				'menuconfig' ) error "NOT IMPLEMENTED"; return 1;;
			esac
		;;
		Compile )
			EBSStartMessage 'Compile'
			DESLBInitialize || return ${?};
			DESLBCompile || return ${?};
		;;
		Install )
			EBSStartMessage 'Install'
			DESLBInitialize || return ${?};
			DESLBInstall || return ${?};
			MakeDLP || return ${?};
		;;
		Clean )
			EBSStartMessage 'Clean'
			DESLBClean || return ${?};
		;;
		*)
			error "Unsupported build mode '${BUILD_MODE}'"
			return 1;
		;;
	esac
	return 0;

}

EBSPrepareBuildDirectory(){ # build_dir, shared_dir
	local W_DIR="${1}";
	local R_DIR="${2}";
	mkdir -p "${W_DIR}"

	local OV_WORK_DIR="${W_DIR}/tmp";
	local OV_UPPER_DIR="${W_DIR}/build";

	export SHARED_SOURCE_DIR='-';
	export IMPORT_BUILD_DIR='-';
	[ ! "${Package_ImportCoreInfo:--}" = '-' ] && {
		vinfo 'This package imports CoreInfo'
		DSH_GetSharedDirectory "${Package_ImportCoreInfo}";

		R_DIR="${SHARED_SOURCE_DIR}";

		IMPORT_BUILD_DIR="${BUILD_DIR}/${GSD_Package_Source_RootDir}";
	}

	[ "${DESLB_SUPPORT_NATIVE_ISOLATION:-0}" = '1' ] && {
		vinfo 'This package supports native isolation'
		SHARED_SOURCE_DIR="${R_DIR}";
		return 0;
	}

	[ "${R_DIR}" = '' ] && {
		R_DIR="/tmp/.blank_dir_${RANDOM}_${RANDOM}";
		mkdir -p "${R_DIR}"
	}

	mkdir -p "${OV_WORK_DIR}"
	mkdir -p "${OV_UPPER_DIR}"

	mount -t overlay "build://${W_DIR}" "${W_DIR}" -o "rw,lowerdir=${R_DIR},upperdir=${OV_UPPER_DIR},workdir=${OV_WORK_DIR}" || return ${?};

	return 0;
}

MakeDLP(){ # ID, DLP Root path
	local L_PKGID_FULL="${1:-${Package_Category}/${Package_ID}}";
	local L_DLP_MAKE_ROOT_DIR="${2:-${DLP_INSTALL_DIR}}";
	local L_DESL_ARCH="${DESL_ARCH}";

	case "${Package_Category}" in
		toolchain-base | toolchain )
			L_DESL_ARCH="${BUILDER_ARCH}";
			;;
	esac

	local L_TEMP_ROOT="${DLP_MAKE_ROOT_DIR}/root";
	[ ! -e "${L_DLP_MAKE_ROOT_DIR}" ] && {
		vinfoex "No files are installed."
		return 0;
	}

	local L_BaseSystem='';
	case "${PACKAGE_ROOT_CATEGORY}" in
		'bootstrap' | 'toolchain-base' | 'toolchain' ) L_BaseSystem='/System:DESLBuilder';;
	esac

	mkdir -p "${L_TEMP_ROOT}/"

	{ # doc
		local M=0;
		mkdir -p "${L_TEMP_ROOT}/share"
		[ -e "${L_DLP_MAKE_ROOT_DIR}/share/doc" ] && {
			mv "${L_DLP_MAKE_ROOT_DIR}/share/doc" "${L_TEMP_ROOT}/share" || return ${?};
			M=1;
		}
		[ -e "${L_DLP_MAKE_ROOT_DIR}/share/man" ] && {
			mv "${L_DLP_MAKE_ROOT_DIR}/share/man" "${L_TEMP_ROOT}/share" || return ${?};
			M=1;
		}
		[ -e "${L_DLP_MAKE_ROOT_DIR}/share/info" ] && {
			mv "${L_DLP_MAKE_ROOT_DIR}/share/info" "${L_TEMP_ROOT}/share" || return ${?};
			M=1;
		}

		# remove share/ if empty
		rmdir "${L_DLP_MAKE_ROOT_DIR}/share/" 2>/dev/null
		rmdir "${L_TEMP_ROOT}/share/" 2>/dev/null

		[ "${M}" = '1' ] && {
			RunDLPI /Create /Dir:"${L_TEMP_ROOT}" \
				/PackageDef:"${PACKAGES_DIR}/${DESL_BUILD_PACKAGE}/DESLPackage.def" \
				/Platform:${L_DESL_ARCH} \
				/ID:${L_PKGID_FULL}-doc \
				/SaveTo:"${DLP_DIR}/${L_PKGID_FULL}-doc_${Package_ID_Suffix}_${L_DESL_ARCH}.dlp" \
				${L_BaseSystem} || return ${?};

			rm -rf "${L_TEMP_ROOT}" || return ${?};
			mkdir -p "${L_TEMP_ROOT}" || return ${?};
		}
	}

	local x;
	vinfo "Strip binaries"
	for x in `find "${L_DLP_MAKE_ROOT_DIR}" -type f`; do
		"${DESL_TARGET}-strip" --strip-unneeded "${x}" > /dev/null 2>&1
	done

	{ # dev
		local M=0;
		local x p;
		mkdir -p "${L_TEMP_ROOT}/lib"

		[ -e "${L_DLP_MAKE_ROOT_DIR}/include" ] && {
			mv "${L_DLP_MAKE_ROOT_DIR}/include" "${L_TEMP_ROOT}" || return ${?};
			M=1;
		}

		[ -e "${L_DLP_MAKE_ROOT_DIR}/lib/pkgconfig" ] && {
			mv "${L_DLP_MAKE_ROOT_DIR}/lib/pkgconfig" "${L_TEMP_ROOT}/lib" || return ${?};
			M=1;
		}

		for x in `find "${L_DLP_MAKE_ROOT_DIR}" -name "*.a"`; do
			p="${L_TEMP_ROOT}/${x#${L_DLP_MAKE_ROOT_DIR}}";
			mkdir -p "${p%/*}" || return ${?};
			mv "${x}" "${p}" || return ${?};
			M=1;
		done

		# remove share/ if empty
		rmdir "${L_TEMP_ROOT}/include/" 2>/dev/null
		rmdir "${L_TEMP_ROOT}/lib/" 2>/dev/null

		[ "${M}" = '1' ] && {
			RunDLPI /Create /Dir:"${L_TEMP_ROOT}" \
				/PackageDef:"${PACKAGES_DIR}/${DESL_BUILD_PACKAGE}/DESLPackage.def" \
				/Platform:${L_DESL_ARCH} \
				/ID:${L_PKGID_FULL}-dev \
				/SaveTo:"${DLP_DIR}/${L_PKGID_FULL}-dev_${Package_ID_Suffix}_${L_DESL_ARCH}.dlp" \
				${L_BaseSystem} || return ${?};
			rm -rf "${L_TEMP_ROOT}" || return ${?};
			mkdir -p "${L_TEMP_ROOT}" || return ${?};
		}

	}

	# Cleanup
	for x in `find "${L_DLP_MAKE_ROOT_DIR}" -name "*.la"`; do
		rm "${x}" || return ${?};
		rmdir "${x%/*}" 2>/dev/null
	done

	CheckEmptyDir "${L_DLP_MAKE_ROOT_DIR}" && {
		warning "No main files found to install."
	} || {
		RunDLPI /Create /Dir:"${L_DLP_MAKE_ROOT_DIR}" \
			/PackageDef:"${PACKAGES_DIR}/${DESL_BUILD_PACKAGE}/DESLPackage.def" \
			/Platform:${L_DESL_ARCH} \
			/ID:${L_PKGID_FULL} \
			/SaveTo:"${DLP_DIR}/${L_PKGID_FULL}_${Package_ID_Suffix}_${L_DESL_ARCH}.dlp" \
			${L_BaseSystem} || return ${?};
	}

	return 0;
}

CheckEmptyDir(){
	local P="${1}";
	set -- ${1}/*
	[ "${P}/*" = "${1}" ] && return 0;
	return 1;
}

EBSStartMessage(){
	infoex "${1}"
	return 0;
}

error(){
	echo -e "\e[31;1mE:\e[m\e[1m [${DESLB_NESTLV}] ${DESL_BUILD_PACKAGE}: ${*}\e[m" >&4
}
warning(){
	echo -e "\e[33;1mW:\e[m\e[1m [${DESLB_NESTLV}] ${DESL_BUILD_PACKAGE}: ${*}\e[m" >&4
}
infoex(){
	echo -e "\e[m\e[1mI:\e[m\e[1m [${DESLB_NESTLV}] ${DESL_BUILD_PACKAGE}: ${*}\e[m" >&3
}
info(){
	echo -e "I: [${DESLB_NESTLV}] ${DESL_BUILD_PACKAGE}: ${*}" >&3
}

# Override by 'VerboseOutput.sh' when DESL_OUTPUT_VERBOSE != 0
vinfo(){
	:
}
vinfoex(){
	:
}


EBSRunDESLBScript "${@}";
